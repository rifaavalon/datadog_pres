name: Dump Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to dump'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
          - all

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  dump-dev:
    name: Dump Dev Infrastructure
    if: ${{ github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'all' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config=environments/dev/backend.hcl

      - name: Get Terraform Outputs
        working-directory: ./terraform
        run: |
          echo "## Dev Environment Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq 'del(.ansible_inventory)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Get AWS Resources
        run: |
          echo "### AWS Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get EC2 instances
          echo "#### EC2 Instances" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,PublicIpAddress,PrivateIpAddress,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get Load Balancers
          echo "#### Load Balancers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `dev`)].{Name:LoadBalancerName,DNS:DNSName,State:State.Code}' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "No load balancers found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  dump-test:
    name: Dump Test Infrastructure
    if: ${{ github.event.inputs.environment == 'test' || github.event.inputs.environment == 'all' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config=environments/test/backend.hcl

      - name: Get Terraform Outputs
        working-directory: ./terraform
        run: |
          echo "## Test Environment Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq 'del(.ansible_inventory)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Get AWS Resources
        run: |
          echo "### AWS Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get EC2 instances
          echo "#### EC2 Instances" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=test" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,PublicIpAddress,PrivateIpAddress,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get Load Balancers
          echo "#### Load Balancers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `test`)].{Name:LoadBalancerName,DNS:DNSName,State:State.Code}' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "No load balancers found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  dump-prod:
    name: Dump Prod Infrastructure
    if: ${{ github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'all' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config=environments/prod/backend.hcl

      - name: Get Terraform Outputs
        working-directory: ./terraform
        run: |
          echo "## Production Environment Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq 'del(.ansible_inventory)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Get AWS Resources
        run: |
          echo "### AWS Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get EC2 instances
          echo "#### EC2 Instances" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=prod" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,PublicIpAddress,PrivateIpAddress,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get Load Balancers
          echo "#### Load Balancers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `prod`)].{Name:LoadBalancerName,DNS:DNSName,State:State.Code}' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "No load balancers found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
