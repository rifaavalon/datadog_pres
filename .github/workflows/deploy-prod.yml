name: Deploy to Production

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0
  ENVIRONMENT: prod

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production  # Requires approval in GitHub settings
    permissions:
      id-token: write
      contents: read
    outputs:
      instance_ips: ${{ steps.tf_outputs.outputs.instance_ips }}
      alb_dns: ${{ steps.tf_outputs.outputs.alb_dns }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config=environments/${{ env.ENVIRONMENT }}/backend.hcl

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var-file=environments/${{ env.ENVIRONMENT }}/terraform.tfvars \
            -var="datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: ./terraform
        run: |
          echo "instance_ips=$(terraform output -json instance_public_ips)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT

  deploy-agents-batch-1:
    name: Deploy Agents - Batch 1 (30%)
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/datadog-demo-key.pem
          chmod 600 ~/.ssh/datadog-demo-key.pem

          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: Generate Inventory for Batch 1
        working-directory: ./ansible
        run: |
          TOTAL=$(echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r 'length')
          BATCH_SIZE=$(( TOTAL * 30 / 100 ))
          if [ $BATCH_SIZE -lt 1 ]; then BATCH_SIZE=1; fi

          cat > inventory/prod-batch1.ini <<EOF
          [prod_batch1]
          EOF

          echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r '.[]' | \
          head -n $BATCH_SIZE | \
          awk '{print "prod-instance-"NR" ansible_host="$1}' >> inventory/prod-batch1.ini

          cat >> inventory/prod-batch1.ini <<EOF

          [prod_batch1:vars]
          environment=prod
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/datadog-demo-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Deploying to Batch 1 ($BATCH_SIZE instances):"
          cat inventory/prod-batch1.ini

      - name: Wait for instances
        run: sleep 90

      - name: Deploy to Batch 1
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/prod-batch1.ini \
            playbooks/deploy-datadog.yml \
            -e "datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -e "datadog_site=us5.datadoghq.com" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify Batch 1
        working-directory: ./ansible
        run: |
          ansible all \
            -i inventory/prod-batch1.ini \
            -m shell \
            -a "sudo datadog-agent status" \
            --become

  deploy-agents-batch-2:
    name: Deploy Agents - Batch 2 (40%)
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-agents-batch-1]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/datadog-demo-key.pem
          chmod 600 ~/.ssh/datadog-demo-key.pem

          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: Generate Inventory for Batch 2
        working-directory: ./ansible
        run: |
          TOTAL=$(echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r 'length')
          BATCH1_SIZE=$(( TOTAL * 30 / 100 ))
          if [ $BATCH1_SIZE -lt 1 ]; then BATCH1_SIZE=1; fi
          BATCH2_SIZE=$(( TOTAL * 40 / 100 ))
          if [ $BATCH2_SIZE -lt 1 ]; then BATCH2_SIZE=1; fi

          cat > inventory/prod-batch2.ini <<EOF
          [prod_batch2]
          EOF

          echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r '.[]' | \
          tail -n +$(( BATCH1_SIZE + 1 )) | head -n $BATCH2_SIZE | \
          awk -v offset=$BATCH1_SIZE '{print "prod-instance-"(NR+offset)" ansible_host="$1}' >> inventory/prod-batch2.ini

          cat >> inventory/prod-batch2.ini <<EOF

          [prod_batch2:vars]
          environment=prod
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/datadog-demo-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Deploying to Batch 2 ($BATCH2_SIZE instances):"
          cat inventory/prod-batch2.ini

      - name: Deploy to Batch 2
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/prod-batch2.ini \
            playbooks/deploy-datadog.yml \
            -e "datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -e "datadog_site=us5.datadoghq.com" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify Batch 2
        working-directory: ./ansible
        run: |
          ansible all \
            -i inventory/prod-batch2.ini \
            -m shell \
            -a "sudo datadog-agent status" \
            --become

  deploy-agents-batch-3:
    name: Deploy Agents - Batch 3 (Remaining)
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-agents-batch-2]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/datadog-demo-key.pem
          chmod 600 ~/.ssh/datadog-demo-key.pem

          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: Generate Inventory for Batch 3
        working-directory: ./ansible
        run: |
          TOTAL=$(echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r 'length')
          BATCH1_SIZE=$(( TOTAL * 30 / 100 ))
          if [ $BATCH1_SIZE -lt 1 ]; then BATCH1_SIZE=1; fi
          BATCH2_SIZE=$(( TOTAL * 40 / 100 ))
          if [ $BATCH2_SIZE -lt 1 ]; then BATCH2_SIZE=1; fi
          SKIP=$(( BATCH1_SIZE + BATCH2_SIZE ))

          cat > inventory/prod-batch3.ini <<EOF
          [prod_batch3]
          EOF

          echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r '.[]' | \
          tail -n +$(( SKIP + 1 )) | \
          awk -v offset=$SKIP '{print "prod-instance-"(NR+offset)" ansible_host="$1}' >> inventory/prod-batch3.ini

          cat >> inventory/prod-batch3.ini <<EOF

          [prod_batch3:vars]
          environment=prod
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/datadog-demo-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Deploying to Batch 3 (remaining instances):"
          cat inventory/prod-batch3.ini

      - name: Deploy to Batch 3
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/prod-batch3.ini \
            playbooks/deploy-datadog.yml \
            -e "datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -e "datadog_site=us5.datadoghq.com" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify Batch 3
        working-directory: ./ansible
        run: |
          ansible all \
            -i inventory/prod-batch3.ini \
            -m shell \
            -a "sudo datadog-agent status" \
            --become

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-agents-batch-3]

    steps:
      - name: Deployment Summary
        run: |
          echo "## ✅ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Load Balancer:** http://${{ needs.deploy-infrastructure.outputs.alb_dns }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Instances:** $(echo '${{ needs.deploy-infrastructure.outputs.instance_ips }}' | jq -r 'length')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Strategy:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Batch 1 (30%) - Complete" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Batch 2 (40%) - Complete" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Batch 3 (Remaining) - Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor for 48 hours" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all metrics in Datadog" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete post-deployment review" >> $GITHUB_STEP_SUMMARY
