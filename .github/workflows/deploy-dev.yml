name: Deploy to Development

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0
  ENVIRONMENT: dev

jobs:
  deploy:
    name: Deploy Infrastructure and Datadog Agents
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config=environments/${{ env.ENVIRONMENT }}/backend.hcl

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var-file=environments/${{ env.ENVIRONMENT }}/terraform.tfvars \
            -var="datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -var="datadog_app_key=${{ secrets.DD_APP_KEY }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var-file=environments/${{ env.ENVIRONMENT }}/terraform.tfvars \
            -var="datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -var="datadog_app_key=${{ secrets.DD_APP_KEY }}"

      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: ./terraform
        run: |
          echo "instance_ips=$(terraform output -json instance_public_ips)" >> $GITHUB_OUTPUT
          echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/datadog-demo-key.pem
          chmod 600 ~/.ssh/datadog-demo-key.pem

          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: Generate Dynamic Ansible Inventory
        working-directory: ./ansible
        run: |
          cat > inventory/${{ env.ENVIRONMENT }}.ini <<EOF
          [${{ env.ENVIRONMENT }}_servers]
          EOF

          echo '${{ steps.tf_outputs.outputs.instance_ips }}' | jq -r '.[]' | \
          awk '{print "${{ env.ENVIRONMENT }}-instance-"NR" ansible_host="$1}' >> inventory/${{ env.ENVIRONMENT }}.ini

          cat >> inventory/${{ env.ENVIRONMENT }}.ini <<EOF

          [${{ env.ENVIRONMENT }}_servers:vars]
          environment=${{ env.ENVIRONMENT }}
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/datadog-demo-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Generated inventory:"
          cat inventory/${{ env.ENVIRONMENT }}.ini

      - name: Wait for instances to be ready
        run: sleep 90

      - name: Test Ansible connectivity
        working-directory: ./ansible
        run: |
          ansible all -i inventory/${{ env.ENVIRONMENT }}.ini -m ping
        continue-on-error: true

      - name: Deploy Datadog Agent
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/${{ env.ENVIRONMENT }}.ini \
            playbooks/deploy-datadog.yml \
            -e "datadog_api_key=${{ secrets.DD_API_KEY }}" \
            -e "datadog_site=us5.datadoghq.com" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify Agent Deployment
        working-directory: ./ansible
        run: |
          ansible all \
            -i inventory/${{ env.ENVIRONMENT }}.ini \
            -m shell \
            -a "sudo datadog-agent status || echo 'Agent not ready yet'" \
            --become
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## âœ… Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Load Balancer:** http://${{ steps.tf_outputs.outputs.alb_dns }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instances:** $(echo '${{ steps.tf_outputs.outputs.instance_ips }}' | jq -r 'length')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Datadog UI: https://app.datadoghq.com/infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "2. Filter by tag: \`env:${{ env.ENVIRONMENT }}\`" >> $GITHUB_STEP_SUMMARY
